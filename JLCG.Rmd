---
title: "Proyecto Data Science - City Bike Dataset"
author: "Costela Guijosa, Jose Luis"
date: "Febrero de 2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require("sf")) install.packages("sf")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
if (!require("scales")) install.packages("scales")

library(sf)
library(RColorBrewer)
library(scales)

```

**NOTA:** Las variables creadas en esta sección empezarán por JLCG para asegurar que no se va a solapar ninguna variable con el análisis del resto de mis compañeros

## ¿Cuáles son las zonas con mayor concentración de bicicletas en la ciudad y cómo podría esto ayudar a recomendar la instalación de nuevas estaciones?

El objetivo de este análisis es identificar aquellas áreas de la ciudad con una mayor concentración de viajes en bicicleta, tanto en lo referente a las estaciones de origen como a las de destino. El estudio de estos patrones de uso permitirá detectar zonas con alta demanda donde podría ser recomendable la instalación de nuevas estaciones, con el fin de optimizar el servicio y mejorar la accesibilidad para los usuarios. Además, este análisis facilitará la redistribución estratégica de las estaciones existentes y permitirá anticipar tendencias futuras en el uso del sistema Citi Bike.

### Desarrollo del análisis

Para abordar esta pregunta, el primer paso ha consistido en analizar y segmentar la zona de Nueva York y Jersey City en distintas áreas, con el objetivo de identificar cuáles son las más utilizadas dentro del servicio de bicicletas. Para ello, se ha utilizado un conjunto de datos externo que divide el área geográfica en diferentes zonas y vecindarios.

Para el área de Jersey City, el dataset ha sido obtenido a través del **Portal de Datos Abiertos de Jersey City**, una plataforma oficial que proporciona acceso a información geográfica y administrativa de la ciudad de Jersey City, en el distrito de Nueva Jersey. El enlace de acceso al dataset es el siguiente: [Portal de Datos Abiertos de Jersey City](https://data.jerseycitynj.gov/explore/dataset/jersey-city-neighborhoods/information/?utm_source=chatgpt.com&location=12,40.70875,-74.05489&basemap=jawg.light).

En el caso de Nueva York, el dataset proviene del **Portal Oficial de Datos Abiertos de la Ciudad de Nueva York**, una plataforma gestionada por el gobierno de la ciudad de Nueva York que ofrece acceso libre a una enorme cantidad de datasets públicos relacionados con diferentes aspectos de la ciudad. En concreto este dataset subdivide el distrito en los sectores utilizados por la policia de Nueva York. Si bien este dataset segmenta el distrito en sectores policiales, resulta válido para este estudio, ya que el objetivo de su incorporación es disponer de una referencia geográfica clara y definida que permita identificar y describir cada sector de forma más precisa y eficiente tras la realización del análisis. El enlace de acceso al dataset es el siguiente: [Portal Oficial de Datos Abiertos de la Ciudad de Nueva York](https://data.cityofnewyork.us/Public-Safety/NYPD-Sectors/eizi-ujye).

Los datasets utilizados, ambos en formato CSV y donde cada registro representa un vecindario o área diferente, presentan las siguientes características:

- Jersey City:
  + Tamaño de archivo: 165 kB
  + Número de atributos: 10
  + Número de instancias: 53
  
- Nueva York:
  + Tamaño de archivo: 4,4 MB
  + Número de atributos: 7
  + Número de instancias: 303

A continuación se describen las variables incluidas en el conjunto de datos referente a Jersey City:

1.  **Geo Point**
    -   Coordenadas del centro del vecindario (latitud y longitud).
2.  **Geo Shape**
    -   Coordenadas del polígono que delimita cada vecindario (objeto GeoJSON).
3.  **cartodb_id**
    -   Identificador único de cada vecindario (número del 1 al 53).
4.  **area_sq_ft**
    -   Área total de la ciudad de Jersey (pies cuadrados).
5.  **acres**:
    -   Área total de la ciudad de Jersey (acres).
6.  **area**:
    -   Nombre del área de la ciudad de Jersey a la que pertenece el vecindario.
7.  **neighborhood**:
    -   Nombre del vecindario de la ciudad de Jersey.
8.  **color**
    -   Código numérico asignado a algunos vecindarios para alguna referencia visual.
    
Por otro lado, las variables incluidas en el conjunto de datos correspondiente al distrito de Nueva York son las siguientes:

1.  **the_geom**
    -   Coordenadas del polígono que delimita cada sector (objeto MULTIPOLYGON).
2.  **sector**
    -   Código identificador único de cada sector policial de la NYPD (ej: 100A).
3.  **pct**
    -   Precinto policial al que pertenece el sector (ej: 100).
4.  **patrol_bor**
    -   Distrito al que pertenece el sector.
5.  **sq_miles**:
    -   Área del sector en millas cuadradas.
6.  **nco_phase**:
    -   Fase o ciclo de implementación del programa NCO.
7.  **sector_ind**:
    -   Indicador alfabético dentro del precinto (ej: "A", "B", "C", etc.).
    
```{r JLCG_integracion}

JLCG_df_map_JC <- read.csv("data/JLCG/jersey-city-neighborhoods.csv", sep = ";")
JLCG_df_map_NY <- read.csv("data/JLCG/NYPD_Sectors.csv")
head(JLCG_df_map_JC)
head(JLCG_df_map_NY)

```
    
Como primer paso para abordar la cuestión planteada, ha sido necesario realizar un proceso de preprocesamiento sobre estos nuevos datasets. En esta fase, se han aplicado los siguientes tratamientos a cada uno de sus atributos:

Dataset de Jersey City:

1.  **Geo Point**
    -   Eliminación de este atributo debido a que no proporciona información de utilidad para el estudio.
2.  **Geo Shape**
    -   Transformación desde su formato original (objeto GeoJSON) a una geometría espacial (sfc).
3.  **cartodb_id**
    -   Eliminación de este atributo debido a que no proporciona información de utilidad para el estudio.
4.  **area_sq_ft**
    -   Eliminación de este atributo debido a que no proporciona información de utilidad para el estudio.
5.  **acres**:
    -   Eliminación de este atributo debido a que no proporciona información de utilidad para el estudio.
6.  **area**:
    -   Conservado sin modificaciones.
7.  **neighborhood**:
    -   Conservado sin modificaciones.
8.  **color**
    -   Eliminación de este atributo debido a que no proporciona información de utilidad para el estudio.
    
```{r JLCG_preprocesamiento_limpieza_JC}

JLCG_df_map_JC$Geo.Shape <- geojsonsf::geojson_sfc(JLCG_df_map_JC$Geo.Shape)

JLCG_df_map_JC <- JLCG_df_map_JC %>% select(-c(Geo.Point, cartodb_id, area_sq_ft, acres, color))

```
    
Dataset de Nueva York:

1.  **the_geom**
    -   Transformación desde su formato original a una geometría espacial (sfc).
2.  **sector**
    -   Conservado sin modificaciones.
3.  **pct**
    -   Eliminación de este atributo debido a que no proporciona información de utilidad para el estudio.
4.  **patrol_bor**
    -   Conservado sin modificaciones.
5.  **sq_miles**:
    -   Eliminación de este atributo debido a que no proporciona información de utilidad para el estudio.
6.  **nco_phase**:
    -   Eliminación de este atributo debido a que no proporciona información de utilidad para el estudio.
7.  **sector_ind**:
    -   Eliminación de este atributo debido a que no proporciona información de utilidad para el estudio.
    
```{r JLCG_preprocesamiento_limpieza_NY}

JLCG_df_map_NY <- JLCG_df_map_NY %>%
  st_as_sf(wkt = "the_geom", crs = 4326)

JLCG_df_map_NY <- JLCG_df_map_NY %>% select(-c(pct, sq_miles, nco_phase, sector_ind))

```

Una vez realizados los procesos de preprocesamiento y tratamiento de ambos dataframes por separado, se procede a su unificación en un único dataframe que integre todos los sectores, abarcando tanto los correspondientes a Nueva York como a Jersey City. Aunque Nueva York y Nueva Jersey pertenecen a diferentes jurisdicciones y administraciones, su integración en un único dataset responde al interés analítico de tratar el sistema Citi Bike como una red conjunta que opera en ambos territorios.

Tras la unificación de los datasets, se obtiene un nuevo conjunto de datos que cuenta con los siguientes atributos:

1.  **geometry**
    -   Coordenadas del polígono que delimita cada sector.
2.  **area**
    -   Distrito o área a la que pertenece el sector o vecindario.
3.  **sector**
    -   Sector o vecindario del distrito de Nueva York y Jersey City.
    
El último paso a seguir es el de transformar el dataframe en un objeto espacial sf, garantizando que leaflet pueda interpretar correctamente las geometrías.

```{r JLCG_preprocesamiento_limpieza_merge}

JLCG_df_map_JC <- JLCG_df_map_JC %>%
  rename(geometry = Geo.Shape,
         area = area,
         sector = neighborhood)

JLCG_df_map_NY <- JLCG_df_map_NY %>%
  rename(geometry = the_geom,
         area = patrol_bor,
         sector = sector)

JLCG_df_map <- bind_rows(JLCG_df_map_JC, JLCG_df_map_NY)

JLCG_df_map <- st_sf(JLCG_df_map)


```

Una vez finalizado el preprocesamiento del dataframe que contiene los sectores de Jersey City, se procede a realizar una agrupación en el dataset principal de este estudio. Esta agrupación se lleva a cabo tomando como referencia las estaciones de bicicletas, contabilizando el número de veces que cada estación aparece como punto de inicio de un viaje y como punto de finalización.

```{r JLCG_agrupacion_estaciones_1}

# Estaciones de salida
JLCG_start_stations <- df_preprocesado %>%
  group_by(start.station.latitude, start.station.longitude) %>%
  summarise(
    count_start = n(),
    start.station.name = names(which.max(table(start.station.name))),
    .groups = "drop"
  )

# Estaciones de llegada
JLCG_end_stations <- df_preprocesado %>%
  group_by(end.station.latitude, end.station.longitude) %>%
  summarise(
    count_end = n(),
    end.station.name = names(which.max(table(end.station.name))),
    .groups = "drop"
  )

```

El siguiente paso consiste en la unificación de los dos dataframes trabajados previamente en un único dataframe. En este nuevo dataframe, cada instancia representa una estación de bicicletas, incluyendo para cada una de ellas su nombre, sus coordenadas geoespaciales y el número total de viajes registrados, tanto como estación de origen como de destino.

```{r JLCG_agrupacion_estaciones_2}

# Unir ambos dataframes por latitud y longitud
JLCG_stations <- full_join(JLCG_start_stations, JLCG_end_stations,
                               by = c("start.station.latitude" = "end.station.latitude",
                                      "start.station.longitude" = "end.station.longitude"))
JLCG_stations <- JLCG_stations %>% select(-start.station.name)
JLCG_stations <- JLCG_stations %>% 
  rename(name = end.station.name) %>% 
  rename(latitude = start.station.latitude) %>% 
  rename(longitude = start.station.longitude)

# Si alguna estación solo aparece en salidas o en llegadas, sustituir NA por 0
JLCG_stations <- JLCG_stations %>%
  mutate(count_start = ifelse(is.na(count_start), 0, count_start),
         count_end = ifelse(is.na(count_end), 0, count_end))

# Columna total de viajes
JLCG_stations <- JLCG_stations %>% mutate(count_total = count_start + count_end)

```

Con el objetivo de identificar las estaciones más concurridas, se plantea realizar un proceso de clustering geoespacial, considerando para cada estación su ubicación geográfica y el número total de usos registrados, tanto como punto de inicio como de finalización de viajes. Para ello, se ha seleccionado el algoritmo de k-means, que permitirá agrupar las estaciones en distintos clústeres según su nivel de actividad y su posición en el mapa, facilitando así la detección de patrones espaciales y la identificación de áreas clave dentro del sistema.

Para garantizar que las distintas variables (latitud, longitud y número total de viajes) tengan un peso equivalente en el clustering, se procede a su normalización. Aunque latitud y longitud ya están en grados, se estandarizan junto al número de viajes para facilitar la convergencia del algoritmo k-means.

Una vez realizado este ajuste, se utiliza el método del codo para determinar el número óptimo de clústeres.

```{r JLCG_metodo_codo}

# Normalización de variables
JLCG_stations_scaled <- JLCG_stations %>%
  mutate(lat_scaled = scale(latitude),
         lon_scaled = scale(longitude),
         count_scaled = scale(count_total))

# Cálculo de WSS para diferentes valores de k
set.seed(123)
JLCG_wss <- sapply(1:10, function(k) {
  kmeans(JLCG_stations_scaled[, c("lat_scaled", "lon_scaled", "count_scaled")], centers = k, nstart = 10)$tot.withinss
})

# Gráfico del método del codo
plot(1:10, JLCG_wss, type = "b", pch = 19, frame = FALSE,
     xlab = "Número de Clusters", ylab = "Suma de Cuadrados Intra-cluster (WSS)",
     main = "Método del Codo para K óptimo")

```

Una vez graficado el método del codo se determina que el número óptimo de cluster se encuentra en 4, por lo que se procede a utilizar el algoritmo kmeans con este valor

```{r JLCG_clustering}

JLCG_k = 4

set.seed(123)
JLCG_kmeans <- kmeans(JLCG_stations_scaled[, c("lat_scaled", "lon_scaled", "count_scaled")], centers = JLCG_k, nstart = 10)

JLCG_stations$cluster <- as.factor(JLCG_kmeans$cluster)

```

Finalmente, el último paso consiste en la representación gráfica de los datos analizados, permitiendo así una interpretación visual que facilite la extracción de conclusiones relevantes a partir de los resultados obtenidos.

```{r JLCG_visualizacion}

JLCG_cluster_palette <- colorFactor(palette = brewer.pal(JLCG_k, "Set1"), domain = JLCG_stations$cluster)
JLCG_areas_palette <- colorFactor(palette = brewer.pal(n = length(unique(JLCG_df_map$area)), "Set3"), domain = JLCG_df_map$area)

# Gráfico 3D
plot_ly(JLCG_stations, 
      x = ~longitude, 
      y = ~latitude, 
      z = ~count_total, 
      type = "scatter3d", 
      mode = "markers",
      color = ~cluster,
      colors = sapply(levels(JLCG_stations$cluster), JLCG_cluster_palette),
      marker = list(size = 5),
      text = ~paste0("<b>Estación:</b> ", name, 
                     "<br><b>Localización:</b> ", latitude, ", ", longitude, 
                     "<br><b>Viajes:</b> ", count_total, 
                     "<br><b>Cluster:</b> ", cluster),
      hoverinfo = "text") %>%
  layout(title = "Clusters geoespaciales - Distribución 3D de estaciones y uso",
      scene = list(
        xaxis = list(title = "Longitud"),
        yaxis = list(title = "Latitud"),
        zaxis = list(title = "Número total de viajes")
      ))

# Mapa
leaflet() %>%
  addTiles() %>%
  addPolygons(data = JLCG_df_map,
              fillColor = ~JLCG_areas_palette(area),
              color = "black",
              weight = 1,
              opacity = 0.8,
              fillOpacity = 0.5,
              popup = ~paste0(
                "<b>Área:</b> ", area, "<br>",
                "<b>Sector:</b> ", sector
              )) %>%
  addCircleMarkers(data = JLCG_stations,
                   lng = ~longitude,
                   lat = ~latitude,
                   color = ~JLCG_cluster_palette(cluster),
                   fillColor = ~JLCG_cluster_palette(cluster),
                   fillOpacity = 0.8,
                   radius = ~rescale(count_total, to = c(3, 10)),
                   popup = ~paste0("<b>Estación:</b> ", name, 
                                   "<br><b>Localización:</b> ", latitude, ", ", longitude, 
                                   "<br><b>Viajes:</b> ", count_total, 
                                   "<br><b>Cluster:</b> ", cluster),
                   label = ~paste0("Estación: ", name))

```

### Conclusiones

A partir del análisis de los datos obtenidos, se concluye que los clusters 2 y 4 son los que presentan una mayor demanda y un uso más intenso de sus estaciones. En particular, las estaciones pertenecientes a estos clusters se localizan en Nueva Jersey. Destaca especialmente el cluster 2, que agrupa las estaciones con mayor número de viajes, situadas principalmente dentro del área de Downtown en Jersey City.

Dentro de esta área, se identifica la estación Grove St PATH como la más demandada de todo el sistema, lo que refleja su papel clave en la red de transporte en bicicleta de la ciudad. Esta estación se encuentra ubicada en el sector Van Vorst Park, dentro del área Downtown.

En base a estos resultados, se concluye que el análisis ha permitido identificar con éxito las zonas estratégicas a reforzar. La recomendación principal es la instalación de nuevas estaciones en el área de Downtown, especialmente en el sector Van Vorst Park, lo que permitirá aliviar la alta demanda registrada en la estación Grove St PATH y mejorar la distribución de bicicletas en esta zona clave.

## ¿Hay diferencias en el uso de bicicletas según el género? ¿Y en la fidelidad de los clientes teniendo en cuenta este?

Para abordar esta cuestión, volvemos a situarnos desde la perspectiva del gestor de la empresa City Bike. El objetivo es realizar un estudio a través de visualización que analice si existen diferencias significativas en el uso de bicicletas en función del género de los usuarios. Esta información podría resultar de gran valor para la empresa, ya que, por ejemplo, permitiría orientar futuras campañas de marketing de manera más efectiva, adaptándolas a las características y comportamientos de cada segmento de usuarios, en caso de detectarse patrones diferenciales relevantes.

### Desarrollo del análisis

Este estudio parte del dataset "df_preprocesado", ya preprocesado previamente.

Dado que el objetivo del análisis es estudiar los viajes realizados en función del género del usuario, el primer paso consiste en eliminar todas aquellas instancias en las que no se dispone de información sobre el género, garantizando así la coherencia y calidad de los resultados obtenidos.

Además, se han realizado varias transformaciones en el dataset, creando tres nuevas columnas que serán de utilidad en las etapas posteriores de este análisis. Estas nuevas variables son:

- month_year: Cadena de texto que representa el mes y el año en el que se ha realizado cada viaje.
- month: Cadena de texto que indica el mes correspondiente a la fecha del viaje realizado.
- weekday: Cadena de texto que indica el día de la semana en el que se ha efectuado el viaje.

```{r}

JLCG_df_gender <- df_preprocesado %>%
  filter(gender != 0) 

# TODO: quitar y cambiar estos valores cuando ya sean tipo string
JLCG_df_gender <- JLCG_df_gender %>%
                    mutate(
                      gender = ifelse(gender == 1, "Hombre", "Mujer"),
                      month_year = format(starttime, "%B %Y"),
                      month = format(starttime, "%B"),            
                      weekday = format(starttime, "%A") 
                    )

```

Tras realizar el tratamiento mencionado, se han generado cuatro nuevos datasets que servirán como base para llevar a cabo el análisis. Los datasets se describen a continuación:

- JLCG_df_monthly: este dataset contine una agrupación por cada mes donde se recoge el número total de viajes en cada mes además de la fecha del primer viaje realizado ese mes para cada uno de los géneros.

```{r}

JLCG_df_monthly <- JLCG_df_gender %>%
  group_by(month_year, gender) %>%
  summarise(n_viajes = n(),
            fecha_minima = min(starttime, na.rm = TRUE),
            .groups = "drop")

```

- JLCG_df_by_month: Este dataset contiene una agrupación por meses, sin diferenciar entre años. En él se recoge la media de duración de los viajes y la media de viajes realizados en cada mes a lo largo de todo el periodo analizado.

```{r}

JLCG_df_by_month <- JLCG_df_gender %>%
  group_by(month, gender) %>%
  summarise(tripduration_mean = mean(tripduration, na.rm = TRUE),
            fecha_minima = min(starttime, na.rm = TRUE),
            total_viajes = n(),
            meses_unicos = n_distinct(floor_date(starttime, "month")),
            media_viajes_por_mes = total_viajes / meses_unicos,
            .groups = "drop")

```

- JLCG_df_by_weekday: Este dataset contiene una agrupación por días de la semana. En él se recoge la media de duración de los viajes y la media de viajes realizados por cada día de la semana a lo largo de todo el periodo analizado.

```{r}

JLCG_df_by_weekday <- JLCG_df_gender %>%
  group_by(weekday, gender) %>%
  summarise(tripduration_mean = mean(tripduration, na.rm = TRUE),
            fecha_minima = min(starttime, na.rm = TRUE),
            total_viajes = n(),
            semanas_unicas = n_distinct(floor_date(starttime, "week")),
            media_viajes_por_dia = total_viajes / semanas_unicas,
            .groups = "drop")

```

- JLCG_df_stack: Este dataset recoge una agrupación de los datos por género y tipo de usuario. En él se calcula el porcentaje que representa cada tipo de usuario (suscriptor u ocasional) dentro de cada uno de los géneros.

```{r}

JLCG_df_stack <- JLCG_df_gender %>%
                  group_by(gender, usertype) %>%
                  summarise(n = n(), .groups = "drop") %>%
                  group_by(gender) %>%
                  mutate(porcentaje = n / sum(n) * 100)

```

Una vez generados estos nuevos datasets, es fundamental definir el orden correcto tanto de los meses como de los días de la semana. Esto garantiza que, en las representaciones gráficas realizadas posteriormente con ggplot, se respete el orden cronológico adecuado. Para ello, los valores correspondientes a los meses y a los días de la semana se convierten en factores, asignándoles un orden específico acorde a su secuencia temporal.

```{r}

JLCG_df_monthly <- JLCG_df_monthly %>%
  mutate(month_year = factor(month_year, levels = unique(month_year[order(fecha_minima)])))

JLCG_df_by_month <- JLCG_df_by_month %>%
  mutate(month = factor(month, levels = c("enero", "febrero", "marzo", "abril", "mayo", "junio", 
                                          "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre")))

JLCG_df_by_weekday <- JLCG_df_by_weekday %>%
  mutate(weekday = factor(weekday, levels = c("lunes", "martes", "miércoles", 
                                               "jueves", "viernes", "sábado", "domingo")))

```

Finalizado el tratamiento de los nuevos datasets, el siguiente paso consiste en representar gráficamente la información, con el objetivo de extraer conclusiones y obtener nuevo conocimiento a partir del análisis realizado.

Las gráficas planteadas se describen a continuación:

- JLCG_grafica_piramide: muestra la evolución mensual del número de viajes realizados en bicicleta por hombres y mujeres para comparar su volumen de uso a lo largo del tiempo.

```{r}

JLCG_grafica_piramide <- ggplot(JLCG_df_monthly, aes(x = month_year, y = ifelse(gender == "Hombre", -n_viajes, n_viajes), fill = gender)) +
                            geom_bar(stat = "identity") +
                            coord_flip() +
                            scale_y_continuous(labels = abs) +
                            scale_fill_manual(values = c("Hombre" = "steelblue", "Mujer" = "plum")) +
                            labs(title = "Uso de bicicletas por mes y género",
                                 x = "Mes",
                                 y = "Número de viajes",
                                 fill = "Género") +
                            theme_minimal()

```

- JLCG_grafica_duracion_diario: muestra la duración media de los viajes en bicicleta para hombres y mujeres en cada día de la semana para comparar cómo varía el tiempo de uso entre géneros según el día.

```{r}

JLCG_grafica_duracion_diario <- ggplot(JLCG_df_by_weekday, aes(x = weekday, y = tripduration_mean, color = gender, group = gender)) +
                                  geom_line(linewidth = 1) +
                                  geom_point(size = 3) +
                                  scale_color_manual(values = c("Hombre" = "steelblue", "Mujer" = "plum")) +
                                  labs(title = "Duración media de viajes por día de la semana y género",
                                       x = "Día de la semana",
                                       y = "Duración media del viaje (minutos)",
                                       color = "Género") +
                                  theme_minimal()

```

- JLCG_grafica_duracion_mensual: muestra la duración media de los viajes en bicicleta para hombres y mujeres a lo largo de los meses del año, permitiendo observar patrones estacionales y diferencias entre géneros.

```{r}

JLCG_grafica_duracion_mensual <- ggplot(JLCG_df_by_month, aes(x = month, y = tripduration_mean, color = gender, group = gender)) +
                                    geom_line(linewidth = 1) +
                                    geom_point(size = 3) +
                                    scale_color_manual(values = c("Hombre" = "steelblue", "Mujer" = "plum")) +
                                    labs(title = "Duración media de viajes por mes y género",
                                         x = "Mes",
                                         y = "Duración media del viaje (minutos)",
                                         color = "Género") +
                                    theme_minimal()

```

- JLCG_grafica_viajes_diario: representa el número medio de viajes realizados por hombres y mujeres en cada día de la semana, lo que permite identificar qué días tienen mayor o menor uso según el género.

```{r}

JLCG_grafica_viajes_diario <- ggplot(JLCG_df_by_weekday, aes(x = weekday, y = media_viajes_por_dia, fill = gender)) +
                                geom_bar(stat = "identity", position = position_dodge()) +
                                scale_fill_manual(values = c("Hombre" = "steelblue", "Mujer" = "plum")) +
                                labs(title = "Número medio de viajes por día de la semana y género",
                                     x = "Día de la semana",
                                     y = "Media de viajes por día",
                                     fill = "Género") +
                                theme_minimal()

```

- JLCG_grafica_viajes_mesual: representa el número medio de viajes realizados por hombres y mujeres en cada mes del año, permitiendo observar patrones estacionales de uso de las bicicletas según el género.

```{r}

JLCG_grafica_viajes_mesual <- ggplot(JLCG_df_by_month, aes(x = month, y = media_viajes_por_mes, fill = gender)) +
                                geom_bar(stat = "identity", position = position_dodge()) +
                                scale_fill_manual(values = c("Hombre" = "steelblue", "Mujer" = "plum")) +
                                labs(title = "Número medio de viajes por mes y género",
                                     x = "Mes",
                                     y = "Media de viajes por mes",
                                     fill = "Género") +
                                theme_minimal()

```

- JLCG_grafica_porcentaje_fidelizacion: muestra la distribución porcentual de hombres y mujeres en función de su tipo de usuario (Subscriber o Customer), permitiendo analizar visualmente cuál de los dos géneros presenta una mayor fidelización al servicio de Citi Bike.

```{r}

JLCG_grafica_porcentaje_fidelizacion <- ggplot(JLCG_df_stack, aes(x = gender, y = porcentaje, fill = usertype)) +
                                          geom_bar(stat = "identity", width = 0.7) +
                                          labs(title = "Distribución de tipo de usuario por género",
                                               x = "Género",
                                               y = "Porcentaje",
                                               fill = "Tipo de usuario") +
                                          theme_minimal() +
                                          geom_text(aes(label = paste0(round(porcentaje, 1), "%")), 
                                                    position = position_stack(vjust = 0.5), size = 4, color = "white")

```

Para representar todas estas gráficas, se ha decidido integrarlas en un dashboard, lo que permite centralizar la visualización y facilita considerablemente el análisis de los datos.

```{r}

(JLCG_grafica_piramide | JLCG_grafica_porcentaje_fidelizacion) / 
(JLCG_grafica_duracion_diario | JLCG_grafica_duracion_mensual) / 
(JLCG_grafica_viajes_diario | JLCG_grafica_viajes_mesual)

```

### Conclusiones

A partir de la visualización de las gráficas generadas, se extraen las siguientes conclusiones relevantes:

- La primera gráfica revela un dato especialmente significativo: el uso del servicio de bicicletas por parte de los hombres es notablemente superior al de las mujeres, llegando a triplicar el número de viajes realizados por el género masculino. Además, se observa un leve crecimiento progresivo en el uso de las bicicletas en ambos géneros, con la excepción del año 2019, donde se aprecia un ligero descenso respecto al año anterior. Este comportamiento sugiere que podría ser interesante plantear campañas de marketing específicas dirigidas al público femenino, con el objetivo de incrementar su participación en el servicio, al ser un segmento de usuarios que aún no ha sido explotado con el mismo éxito que el masculino.

- En la segunda gráfica, se observa que existe un mayor porcentaje de usuarios suscriptores dentro del género masculino en comparación con el femenino. Esta diferencia pone de manifiesto la necesidad de que el departamento de marketing explore estrategias específicas para fomentar la fidelización entre las usuarias, incentivando que aquellas que actualmente utilizan el servicio de forma ocasional se conviertan en suscriptoras. Este cambio de comportamiento podría traducirse en un aumento de ingresos recurrentes para la compañía.

- El análisis de las gráficas JLCG_grafica_duracion_diario y JLCG_grafica_viajes_diario permite extraer varios patrones interesantes. Por un lado, se detecta un incremento en la duración media de los viajes durante los fines de semana, especialmente entre las mujeres. Esto sugiere que durante los fines de semana las bicicletas se utilizan con mayor frecuencia para paseos recreativos, mientras que entre semana predominan los desplazamientos funcionales (por ejemplo, para ir al trabajo). Además, se observa un gran descenso en el número de viajes realizados por los hombres durante los fines de semana, lo que refuerza esta hipótesis. Para el equipo de desarrollo de negocio, podría resultar útil analizar si es más rentable fomentar un mayor número de viajes cortos, como ocurre entre semana, o favorecer un menor numero de viajes, aunque de una duración mayor. Esta información puede orientar el diseño de campañas específicas según el perfil temporal de uso.

- Por último, las gráficas JLCG_grafica_duracion_mensual y JLCG_grafica_viajes_mensual muestran que la evolución mensual del uso es muy similar para ambos géneros, con un claro incremento en los meses de verano. Este comportamiento estacional es esperable y coherente con el uso recreativo del servicio. Sin embargo, destaca un comportamiento particular en el mes de marzo, donde se observa que, de forma excepcional, la duración media de los viajes masculinos supera a la de los viajes femeninos. Este dato podría estar vinculado a algún evento específico se tenga en esa época del año. Esta anomalía resulta especialmente interesante para los departamentos de marketing y desarrollo de negocio, ya que evidencia la posible influencia de eventos externos en el uso del servicio. Analizar este tipo de correlaciones podría permitir a la empresa anticiparse y diseñar campañas especiales vinculadas a eventos locales, maximizando así el impacto positivo sobre la demanda del servicio.
