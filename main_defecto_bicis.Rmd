---
title: "Proyecto Data Science - City Bike Dataset"
author: 
  - "Costela Guijosa, Jose Luis"
  - "Reyes López, Marta"
  - "Rodríguez Dueñas, Aitor"
  - "Sánchez Jiménez, Manuel"
date: "Febrero de 2025"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require("dplyr")) install.packages("dplyr")
if (!require("readr")) install.packages("readr")
if (!require("geosphere")) install.packages("geosphere")
if (!require("lubridate")) install.packages("lubridate")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("plotly")) install.packages("plotly")
if (!require("patchwork")) install.packages("patchwork")

library(patchwork)
library(dplyr)
library(readr)
library(geosphere)
library(lubridate)
library(ggplot2)
library(plotly)

```

### ¿Como puedo saber cuáles podrían ser las bicis más susceptibles a tener algún defecto?

En esta sección, consideramos el escenario en el que somos propietarios de una empresa de bicicletas. Resulta fundamental implementar un plan de mantenimiento eficiente. Para ello, es necesario llevar a cabo un análisis que permita al equipo de mantenimiento identificar qué bicicletas presentan un mayor riesgo de fallos o cuáles deberían recibir prioridad para un mantenimiento preventivo, con el objetivo de minimizar posibles incidentes e imprevistos.

El dataset disponible nos permite realizar este análisis mediante la evaluación de distintos factores, como el promedio de velocidad de las bicicletas, que podría indicar la presencia de anomalías mecánicas, o la frecuencia de uso de cada unidad, lo que ayudaría a detectar aquellas que requieren una revisión más exhaustiva.

## Resolución de preguntas

El primer aspecto a considerar es el preprocesamiento necesario para garantizar un análisis preciso y relevante. Para garantizar que el análisis refleje el estado actual del servicio, se ha decidido utilizar únicamente los datos del último año. Esta decisión se debe a que la información más antigua podría no ser relevante para la toma de decisiones operativas. Por ejemplo, conocer la velocidad de una bicicleta en 2016 no aportaría valor, ya que, en caso de haber presentado algún problema, es probable que ya haya sido reparada o retirada del sistema. Al centrarnos en los datos recientes, aseguramos que los hallazgos sean representativos de la situación actual y permitan tomar decisiones basadas en información actualizada.

```{r bicis_fallo_preprocesamiento_1}

df_susceptibles_fallo <- df_preprocesado %>%
  filter(format(starttime, "%Y") %in% c("2020", "2021"))

```

El siguiente aspecto a considerar en el preprocesamiento es la eliminación de valores atípicos (outliers). En particular, es importante identificar y gestionar casos en los que la bicicleta haya sido tomada y dejada en la misma estación. Dado el método de cálculo utilizado para la velocidad (distancia entre estaciones dividida por el tiempo de viaje), estos casos resultan en una velocidad igual a cero. Este fenómeno puede distorsionar el análisis y afectar la interpretación de los resultados, por lo que es necesario aplicar estrategias adecuadas para su tratamiento.

```{r bicis_fallo_preprocesamiento_2}

df_susceptibles_fallo <- df_susceptibles_fallo %>% filter(distance_km != 0)

```

Una vez eliminados los registros con distancias iguales a cero, se procede a revisar la existencia de posibles valores anómalos en las variables de duración del viaje y velocidad. Esta revisión tiene como objetivo detectar y eliminar las siguientes casuísticas:
- Viajes en los que, en lugar de desplazarse de un punto a otro, el usuario ha utilizado la bicicleta para realizar un recorrido circular o recreativo. Este tipo de trayectos puede generar velocidades calculadas que no reflejan un uso típico del sistema, afectando al análisis posterior.
- Viajes con velocidades irreales, superiores a las que puede alcanzar un ciclista en condiciones normales.

```{r bicis_fallo_preprocesamiento_3}

# Boxplot de la duracion de los viajes
p1_tripduration <- ggplot(df_susceptibles_fallo, aes(y = tripduration)) +
  geom_boxplot(fill="steelblue", outlier.color="red") +
  labs(title="Boxplot de la duracion de los Viajes", y="Tiempo") +
  theme_minimal()

# Boxplot de la velocidad de los viajes
p2_speed <- ggplot(df_susceptibles_fallo, aes(y = speed)) +
  geom_boxplot(fill="steelblue", outlier.color="red") +
  labs(title="Boxplot de la velocidad de los Viajes", y="Velocidad") +
  theme_minimal()

(p1_tripduration | p2_speed)

```

Tras el análisis de los datos, se observa la presencia de un elevado número de valores atípicos en la variable de duración de los viajes. Por este motivo, se ha decidido establecer un límite máximo de 75 minutos, al considerar que este es el tiempo máximo razonable que un usuario podría tardar en completar un trayecto, incluso en el caso de que la bicicleta presentase algún tipo de avería. Este valor se ha revisado analizando en google maps el tiempo del viaje que estima esta aplicación al ir entre las dos estaciones más distantes de nuestro dataset. Este valor está en torno a 45 minutos, decidiendo por nuestra parte añadir media hora más para no perder datos sensibles.

En cuanto a las velocidades registradas, se ha comprobado que los valores máximos observados son consistentes con velocidades reales alcanzables por un ciclista. Por lo tanto, en este caso no se considera necesario eliminar ninguna instancia en función de la variable de velocidad.

```{r bicis_fallo_preprocesamiento_4}

df_susceptibles_fallo <- df_susceptibles_fallo %>% filter(tripduration<=75)

# Boxplot de la duracion de los viajes
p1_tripduration_filtrado <- ggplot(df_susceptibles_fallo, aes(y = tripduration)) +
  geom_boxplot(fill="steelblue", outlier.color="red") +
  labs(title="Boxplot del tiempo de los viajes (Filtrado)", y="Tiempo del viaje") +
  theme_minimal()

# Boxplot de la velocidad de los viajes
p2_speed_filtrado <- ggplot(df_susceptibles_fallo, aes(y = speed)) +
  geom_boxplot(fill="steelblue", outlier.color="red") +
  labs(title="Boxplot de la velocidad de los Viajes (Filtrado)", y="Velocidad") +
  theme_minimal()

(p1_tripduration_filtrado | p2_speed_filtrado)


```

Una vez eliminadas todas las instancias de trayectos que puedan afectar a nuestro análisis se ha procedido a la creación de un dataset que agrupe los datos preprocesados por bike_id, de forma que obtengamos un dataset en el que cada instancia sea una bicicleta y que tenga los siguientes atributos:

1.  **bikeid**
    - Identificador único de cada bicicleta
2.  **velocidad_media**
    - Velocidad media a la que ha ido cada bicicleta (km/h).
3.  **ultima_vez_utilizada**
    - Fecha y hora de la última vez que se utilizó cada bicicleta.
4.  **primera_vez_utilizada**
    - Fecha y hora de la primera vez que se utilizó cada bicicleta.
5.  **km_totales**
    - Distancia total recorrida por cada bicicleta (km).
6.  **distancia_media_por_dia**:
    - Distancia media recorrida por cada bicicleta por día.
7.  **veces_utilizada**:
    - Número de veces que se ha utilizado cada bicicleta.
8.  **dias_uso**:
    - Número de días entre primera_vez_utilizada y ultima_vez_utilizada.
9.  **media_usos_por_dia**
    - Media de usos de cada bicicleta por día.

```{r bicis_fallo_nuevo_df}

df_bikes <- df_susceptibles_fallo %>%
  group_by(bikeid) %>%
  summarise(
    velocidad_media = mean(speed, na.rm = TRUE),
    ultima_vez_utilizada = max(starttime, na.rm = TRUE),
    primera_vez_utilizada = min(starttime, na.rm = TRUE),
    km_totales = sum(distance_km, na.rm = TRUE),
    distancia_media_por_dia = mean(distance_km / as.numeric(difftime(max(starttime), min(starttime), units="days") + 1), na.rm = TRUE), 
    veces_utilizada = n(),
    dias_uso = as.numeric(difftime(ultima_vez_utilizada, primera_vez_utilizada, units="days")) + 1,
    media_usos_por_dia = veces_utilizada / dias_uso 
  )

```

Con el conjunto de datos ya preparado, el siguiente paso consiste en catalogar las bicicletas según el nivel de prioridad en su revisión. En este sentido, se ha considerado que aquellas bicicletas que llevan un largo periodo sin ser utilizadas deben ser priorizadas en el proceso de inspección y mantenimiento. Concretamente, se ha establecido que las bicicletas que no han sido utilizadas en los últimos tres meses serán clasificadas como prioritarias para su revisión.

```{r bicis_fallo_no_usadas}

df_bikes_not_used <- df_bikes %>% filter(ultima_vez_utilizada > as.Date("2020-11-01"))
df_bikes_used <- df_bikes %>% filter(ultima_vez_utilizada <= as.Date("2020-11-01"))

```

Para el resto de bicicletas, es decir, aquellas que sí han sido utilizadas en los últimos tres meses, se ha decidido establecer su nivel de prioridad en la revisión mediante un proceso de clustering. Este análisis se basa en tres variables clave: la velocidad media, la distancia media recorrida por día y la media de usos por día. La selección de estas variables responde a los siguientes razonamientos:

- Velocidad media baja: podría indicar que la bicicleta presenta algún defecto mecánico que impide al usuario circular a una velocidad normal.
- Distancia media recorrida baja: podría ser señal de que los usuarios detectan un problema al inicio del trayecto y deciden devolver la bicicleta rápidamente.
- Media de usos por día baja: una baja frecuencia de uso puede sugerir que los usuarios evitan dicha bicicleta por considerar que presenta algún tipo de fallo.

Por todo ello, se construirá un nuevo dataframe que contendrá exclusivamente estas variables clave, sobre el cual se aplicará el proceso de clustering para determinar diferentes niveles de prioridad en la revisión de las bicicletas.

```{r bicis_fallo_df_clustering}

datos_cluster <- df_bikes_used %>% 
  select(velocidad_media, distancia_media_por_dia, media_usos_por_dia)
  
datos_cluster <- scale(datos_cluster)

```

A continuación, se aplica el método del codo para determinar el número óptimo de clusters en el análisis de clustering.

```{r bicis_fallo_metodo_codo}
set.seed(123) 
wss <- sapply(1:10, function(k){
  kmeans(datos_cluster, centers = k, nstart = 10)$tot.withinss
})

plot(1:10, wss, type="b", pch = 19, frame = FALSE,
     xlab="Número de Clusters", ylab="Suma de cuadrados dentro del grupo")

```

Tal y como se observa en la gráfica, el punto en el que la curva comienza a aplanarse indica el número óptimo de clusters, que en este caso es 4.

Para finalizar, se ha decidido utilizar la técnica de clustering K-Means con 4 clusters para agrupar las bicicletas según sus características de uso. Se utilizan las variables velocidad media, distancia media recorrida por día y media de usos por día para segmentarlas en grupos con comportamientos similares.

```{r bicis_fallo_clustering}
set.seed(123)
kmeans_result <- kmeans(datos_cluster, centers = 4, nstart = 10)

df_bikes_used$cluster <- as.factor(kmeans_result$cluster)

plot_ly(df_bikes_used, 
        x = ~velocidad_media, 
        y = ~distancia_media_por_dia, 
        z = ~media_usos_por_dia, 
        color = ~cluster, 
        colors = "Set1",
        type = "scatter3d", 
        mode = "markers") %>%
  layout(title = "Clustering de Bicicletas en 3D",
         scene = list(xaxis = list(title = "Velocidad Media"),
                      yaxis = list(title = "Distancia Media por Día"),
                      zaxis = list(title = "Media Usos por Día")))

```

## Conclusiones

Tras la realización del análisis propuesto, se han obtenido varias agrupaciones que permiten clasificar las bicicletas en función de su probabilidad de presentar algún tipo de problema. Esta clasificación ha servido para establecer un sistema de prioridades en el mantenimiento de la flota, ordenando las bicicletas desde aquellas que requieren una revisión urgente hasta las que presentan un menor riesgo de incidencia.

Para ello, se han definido cinco categorías de prioridad: 'Muy alta', 'Alta', 'Media', 'Baja' y 'Muy baja', con los siguientes criterios de asignación:

- Prioridad "Muy alta": Incluye las bicicletas que no han sido utilizadas en los últimos tres meses. La falta de uso prolongado sugiere que estos vehículos podrían presentar averías importantes o ser percibidos por los usuarios como defectuosos.
- Prioridad "Alta": Comprende las bicicletas pertenecientes al cluster 1, caracterizadas por una baja media de usos diarios y una baja velocidad media, lo que puede indicar posibles fallos mecánicos.
- Prioridad "Media": Corresponde a las bicicletas asignadas al cluster 2, que presentan una mayor media de usos diarios, aunque mantienen una velocidad media baja, lo que podría alertar sobre problemas de funcionamiento moderados.
- Prioridad "Baja": Se ha asignado a las bicicletas del cluster 4, caracterizadas por un comportamiento estable en cuanto a su uso diario y con velocidades medias elevadas, lo que sugiere un buen estado general.
Prioridad "Muy baja": Engloba las bicicletas pertenecientes al cluster 3, que destacan por recorrer mayores distancias diarias, lo que indica un alto nivel de confianza por parte de los usuarios y un estado técnico óptimo.

```{r bicis_fallo_prioridades}

df_prioridades_revision <- bind_rows(
  df_bikes_not_used %>% 
    transmute(bikeid, prioridad = "Muy alta"),
  
  df_bikes_used %>%
    transmute(bikeid, 
              prioridad = case_when(
                cluster == "1" ~ "Alta",
                cluster == "2" ~ "Media",
                cluster == "4" ~ "Baja",
                cluster == "3" ~ "Muy baja"
              ))
)

str(df_prioridades_revision)

```