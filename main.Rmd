---
title: "Proyecto Data Science - City Bike Dataset"
author: 
  - "Costela Guijosa, Jose Luis"
  - "Reyes López, Marta"
  - "Rodríguez Dueñas, Aitor"
  - "Sánchez Jiménez, Manuel"
date: "Febrero de 2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require("dplyr")) install.packages("dplyr")
if (!require("readr")) install.packages("readr")
if (!require("geosphere")) install.packages("geosphere")

library(dplyr)
library(readr)
library(geosphere)
```

## Introducción

Explicar un poco el objetivo del trabajo y demás. Siguiendo la rúbrica: - ¿De qué va el trabajo? - ¿Por qué es interesante? - ¿Volumen de negocio del dominio? - ¿Importancia local/nacional y en el contexto actual

## Descripción del dataset

Explicar el dataset. Siguiendo la rúbrica: - Indicar el tamaño en KB/MB/GB del dataset - Indicar el número de filas y columnas - Indicar origen del dataset

## Importación, limpieza y tratamiento

Siguiendo la rúbrica: Describen los detalles, problemas, transformaciones realizadas al importar y limpiar el dataset, o como mínimo indican que no ha habido ninguno. Si el dataset estaba pre-tratado indican la fuente y quien realizó el tratamiento.Describen los detalles, problemas, transformaciones realizadas al importar y limpiar el dataset, o como mínimo indican que no ha habido ninguno. Si el dataset estaba pre-tratado indican la fuente y quien realizó el tratamiento.

```{r compilación y obtención del dataset base}
archivos_csv <- list.files(path = "data/combined", pattern = "(?i)\\.csv$", full.names = TRUE)
nombres_columnas <- c("tripduration", "starttime", "stoptime", "start.station.id",
                      "start.station.name", "start.station.latitude", "start.station.longitude",
                      "end.station.id", "end.station.name", "end.station.latitude", 
                      "end.station.longitude", "bikeid", "usertype", "birth.year", "gender")


df_combinado <- archivos_csv %>%
  lapply(function(archivo) {
    cat("Procesando:", archivo, "\n")
    df_col <- read_csv(archivo, show_col_types = FALSE)
    colnames(df_col) <- nombres_columnas
    return(df_col)
  }) %>%
  bind_rows()

write_csv(df_combinado, "data/bike_datas.csv")
```

# TODO: Hay que analizar que hay rutas que cogen la bici y la dejan en el mismo punto

# TODO: Hay que revisar que hay velocidades de tortuga. Quitar outliers?

```{r importacion_limpieza_tratamiento}

df <- read.csv("data/bike_data.csv", stringsAsFactors = FALSE)

df %>% summarise_all(~ sum(is.na(.)))

df <- df %>% select(-c(birth.year))
df <- df %>% mutate(gender = ifelse(is.na(gender), "NO_DEF", gender))
df <- df %>% mutate(tripduration = tripduration / 60)

df$distance_km <- distHaversine(df[, c("start.station.longitude", "start.station.latitude")], 
                                 df[, c("end.station.longitude", "end.station.latitude")]) / 1000


df <- df %>% mutate(speed = (distance_km / tripduration)*60)



```

## Preguntas a resolver (cambiar nombre del apartado??) (Poner este apartado al principio?)

Explicar las preguntas en este apartado y que queremos resolver.

Siguiendo rúbrica: - ¿Es una pregunta que se me hubiera planteado al conocer el dominio? - ¿Es representativo el dataset para poder abordar esas preguntas?, ¿tiene sentido esa pregunta con esos datos? - ¿Tendría algún tipo de utilidad el resultado de la respuesta en la realidad?

## Resolución de preguntas

Resolvemos aquí las preguntas etc etc.

Siguiendo rúbrica: - La complejidad e idoneidad de las técnicas de resolución empleadas. Se puntuarán mejor el uso de técnicas de machine learning o tests estadísticos a simples visualizaciones directas de los datos.

Siguiendo rúbrica para visualización: - ¿Ha mostrado alguna visualización? ¿Cuántas? - ¿Siguen los criterios explicados en clase respecto de la veracidad y claridad de las visualizaciones? - ¿Les falta algún tipo de información contextual importante para entender el gráfico? - ¿Es el gráfico más adecuado para lo que quieren representar?

# ¿Cuando realizo el mantenimiento de las bicicletas?

El análisis a realizar para responder a esta pregunta es identificar los períodos de menor uso de las bicicletas, lo que nos permitirá recomendar los meses y estaciones más adecuados para realizar el mantenimiento sin afectar significativamente la disponibilidad del servicio.

Siguiendo rúbrica: - ¿Es una pregunta que se me hubiera planteado al conocer el dominio? - ¿Es representativo el dataset para poder abordar esas preguntas?, ¿tiene sentido esa pregunta con esos datos? - ¿Tendría algún tipo de utilidad el resultado de la respuesta en la realidad?

## Resolución de preguntas

1.  Extraer el mes y la estación del año La columna starttime indica la fecha y hora en que cada viaje comenzó. A partir de ella, extraemos el mes (month) y la estación (season). Las estaciones se definen de acuerdo con la meteorología estándar: · Invierno: Diciembre, Enero, Febrero · Primavera: Marzo, Abril, Mayo · Verano: Junio, Julio, Agosto · Otoño: Septiembre, Octubre, Noviembre

2.  Contar el número de viajes por mes y estación · Agrupar los datos por month y season permite identificar la cantidad total de viajes en cada periodo. · El recuento total de viajes (total_rides) se obtiene con n(), lo que nos dice en qué meses hay menor demanda.

## Visualizar los resultados

Se usa un gráfico de barras con ggplot2, donde el eje X representa los meses y el eje Y la cantidad de viajes. Los colores indican la estación del año para detectar tendencias estacionales.

## Justificación de este método

-   Evita interrupciones en la demanda: Si realizamos mantenimiento en los meses con menor uso, reducimos el impacto en los usuarios.

-   Aprovecha la estacionalidad: En muchos lugares, la demanda baja en invierno debido al clima, lo que lo hace un momento ideal para mantenimiento. · Permite planificación basada en datos: En lugar de hacer mantenimientos arbitrarios, tomamos decisiones respaldadas por datos históricos.

Siguiendo rúbrica: - La complejidad e idoneidad de las técnicas de resolución empleadas. Se puntuarán mejor el uso de técnicas de machine learning o tests estadísticos a simples visualizaciones directas de los datos.

```{r}
library(ggplot2)
library(lubridate)


df$starttime <- ymd_hms(df$starttime, tz="UTC")

df$month <- month(df$starttime, label = TRUE, abbr = TRUE)  


df$season <- case_when(
  df$month %in% c("dic", "ene", "feb") ~ "Invierno",
  df$month %in% c("mar", "abr", "may") ~ "Primavera",
  df$month %in% c("jun", "jul", "ago") ~ "Verano",
  df$month %in% c("sep", "oct", "nov") ~ "Otoño",
  TRUE ~ NA_character_  
)

df_counts <- df %>% 
  group_by(month, season) %>% 
  summarise(total_rides = n(), .groups = 'drop')

df_counts

ggplot(df_counts, aes(x = month, y = total_rides, fill = season)) +
  geom_bar(stat = "identity") +
  labs(title = "Uso de bicicletas por mes y estación del año",
       x = "Mes", y = "Número de viajes") +
  theme_minimal()

```

```{r}

df$hour <- hour(df$starttime)
df$time_period <- case_when(
  df$hour >= 0 & df$hour < 6  ~ "Madrugada",
  df$hour >= 6 & df$hour < 12 ~ "Mañana",
  df$hour >= 12 & df$hour < 18 ~ "Tarde",
  df$hour >= 18 & df$hour < 24 ~ "Noche",
  TRUE ~ NA_character_
)


df_counts <- df %>%
  group_by(time_period) %>%
  summarise(total_rides = n(), .groups = 'drop')

df_counts

ggplot(df_counts, aes(x = time_period, y = total_rides, fill = time_period)) +
  geom_bar(stat = "identity") +
  labs(title = "Uso de bicicletas por franja horaria",
       x = "Franja horaria", y = "Número de viajes") +
  theme_minimal() +
  scale_fill_manual(values = c("Madrugada" = "#1b9e77", "Mañana" = "#d95f02",
                               "Tarde" = "#7570b3", "Noche" = "#e7298a"))
```

```{r}
df_counts <- df %>%
  group_by(season, time_period) %>%
  summarise(total_rides = n(), .groups = 'drop')

df_counts

# Visualizar el uso de bicicletas por franja horaria y estación del año
ggplot(df_counts, aes(x = time_period, y = total_rides, fill = season)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Uso de bicicletas por franja horaria y estación del año",
       x = "Franja horaria", y = "Número de viajes", fill = "Estación") +
  theme_minimal() +
  scale_fill_manual(values = c("Invierno" = "#1f77b4", "Primavera" = "#2ca02c", 
                               "Verano" = "#ff7f0e", "Otoño" = "#d62728"))
```

```{r}
df <- df %>%
  mutate(start_hour = hour(starttime),
         start_day = wday(starttime, label = TRUE))

df

# Contar número de viajes por estación de inicio
station_usage <- df %>%
  group_by(start.station.id, start.station.name, start.station.latitude, start.station.longitude) %>%
  summarise(total_starts = n(), .groups = "drop") %>%
  arrange(desc(total_starts))

# Contar número de viajes por hora del día sin advertencia
hourly_usage <- df %>%
  group_by(start_hour) %>%
  summarise(trips = n(), .groups = "drop") %>%
  arrange(trips)

hourly_usage

station_usage

ggplot(hourly_usage, aes(x = start_hour, y = trips)) +
  geom_col(fill = "steelblue") +
  labs(title = "Cantidad de viajes por hora",
       x = "Hora del día",
       y = "Número de viajes") +
  theme_minimal()



library(leaflet)
summary(station_usage)
station_usage <- station_usage %>%
  filter(!is.na(start.station.longitude) & !is.na(start.station.latitude))
#
#leaflet(data = station_usage) %>%
#  addTiles() %>%
#  addCircleMarkers(
#    lng = ~start.station.longitude, 
#    lat = ~start.station.latitude,
#    radius = ~sqrt(total_starts) * 2, 
#    color = "red",
#    stroke = FALSE,  # Eliminar borde
#    fillOpacity = 0.5,
#    label = ~paste0(start.station.name, ": ", total_starts, " viajes")
#  )

```

## Conclusiones

Indicar resultados y conclusiones a las preguntas.

Siguiendo rúbrica: - ¿Han respondido a las cuestiones planteadas? - ¿Es coherente la conclusión con el resto del proceso? - ¿Es realmente una conclusión lo que se ha obtenido o es una declaración de intenciones?
