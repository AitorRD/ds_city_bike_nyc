---
title: "Proyecto Data Science - Pregunta Individiual 2"
author: "Rodríguez Dueñas, Aitor"
output: html_document
runtime: shiny
---

# Cargar librerías y datos
```{r setup, include=FALSE}
if (!require("readr")) install.packages("readr")
if (!require("geosphere")) install.packages("geosphere")
if (!require("dplyr")) install.packages("dplyr")
if (!require("leaflet")) install.packages("leaflet")

library(dplyr)
library(leaflet)
library(shiny)
library(readr)
library(shinyWidgets)
```

# UI: Interfaz de usuario con filtros
```{r}
ui <- fluidPage(
  titlePanel("Mapa de Rutas de Bicicletas"),
  sidebarLayout(
    sidebarPanel(
      pickerInput("year", "Seleccionar Año:", choices = unique(substr(df$starttime, 1, 4)), multiple = TRUE, selected = unique(substr(df$starttime, 1, 4))),
      sliderInput("num_rutas", "Número de rutas a mostrar:", min = 1, max = 100, value = 50),
      selectInput("gender", "Género:", choices = c("Todos" = "all", "Masculino" = 1, "Femenino" = 2), selected = "all"),
      selectInput("usertype", "Tipo de usuario:", choices = c("Todos" = "all", "Subscriber" = "Subscriber", "Customer" = "Customer"), selected = "all"),
      sliderInput("age_range", "Rango de edad:", min = 18, max = 80, value = c(18, 80))
    ),
    
    mainPanel(
      leafletOutput("map")
    )
  )
)
```

# Servidor con lógica de filtrado y visualización
```{r}
server <- function(input, output, session) {
  
  filtered_data <- reactive({
    df %>%
      filter(substr(starttime, 1, 4) %in% input$year) %>%
      filter(if (input$gender != "all") gender == as.numeric(input$gender) else TRUE) %>%
      filter(if (input$usertype != "all") usertype == input$usertype else TRUE)
  })
  
  output$map <- renderLeaflet({
    data <- filtered_data()
    
    # Contar las rutas más frecuentes
    rutas_freq <- data %>%
      group_by(start.station.id, end.station.id) %>%
      summarise(frecuencia = n()) %>%
      arrange(desc(frecuencia)) %>%
      head(input$num_rutas)
    
    # Crear el mapa
    leaflet(data) %>%
      addTiles() %>%
      
      # Agregar estaciones en azul con ícono de bicicleta
      addAwesomeMarkers(
        lng = data$start.station.longitude, lat = data$start.station.latitude,
        icon = awesomeIcons(icon = "bicycle", markerColor = "blue"),
        popup = ~start.station.name
      ) %>%
      
      # Agregar rutas en rojo
      addPolylines(
        lng = ~c(start.station.longitude, end.station.longitude),
        lat = ~c(start.station.latitude, end.station.latitude),
        color = "red", weight = 2, opacity = 0.8
      )
  })
}
```

# Ejecutar aplicación
```{r}
shinyApp(ui, server)
```